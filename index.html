import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Building, RefreshCw, ArrowRightLeft, Info, Save, Trash2 } from 'lucide-react';
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue 
} from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";

const ResidenceCalculator = () => {
  // 2025年的月份数据
  const months = [
    { id: 0, name: "1月", days: 31, year: 2025, month: 1 },
    { id: 1, name: "2月", days: 28, year: 2025, month: 2 },
    { id: 2, name: "3月", days: 31, year: 2025, month: 3 },
    { id: 3, name: "4月", days: 30, year: 2025, month: 4 },
    { id: 4, name: "5月", days: 31, year: 2025, month: 5 },
    { id: 5, name: "6月", days: 30, year: 2025, month: 6 },
    { id: 6, name: "7月", days: 31, year: 2025, month: 7 },
    { id: 7, name: "8月", days: 31, year: 2025, month: 8 },
    { id: 8, name: "9月", days: 30, year: 2025, month: 9 },
    { id: 9, name: "10月", days: 31, year: 2025, month: 10 },
    { id: 10, name: "11月", days: 30, year: 2025, month: 11 },
    { id: 11, name: "12月", days: 31, year: 2025, month: 12 }
  ];

  // 2025年内地法定节假日安排（包括调休）- 根据最新通知更新
  const holidays = {
    // 一、元旦：1月1日（周三）放假1天，不调休。
    "2025-01-01": { name: "元旦", type: "holiday" },
    
    // 二、春节：1月28日（农历除夕、周二）至2月4日（农历正月初七、周二）放假调休，共8天。
    // 1月26日（周日）、2月8日（周六）上班。
    "2025-01-26": { name: "调休", type: "workday" },  // 周日上班
    "2025-01-28": { name: "除夕", type: "holiday" },
    "2025-01-29": { name: "春节", type: "holiday" },
    "2025-01-30": { name: "春节", type: "holiday" },
    "2025-01-31": { name: "春节", type: "holiday" },
    "2025-02-01": { name: "春节", type: "holiday" },
    "2025-02-02": { name: "春节", type: "holiday" },
    "2025-02-03": { name: "春节", type: "holiday" },
    "2025-02-04": { name: "春节", type: "holiday" },
    "2025-02-08": { name: "调休", type: "workday" },  // 周六上班
    
    // 三、清明节：4月4日（周五）至6日（周日）放假，共3天。
    "2025-04-04": { name: "清明节", type: "holiday" },
    "2025-04-05": { name: "清明节", type: "holiday" },
    "2025-04-06": { name: "清明节", type: "holiday" },
    
    // 四、劳动节：5月1日（周四）至5日（周一）放假调休，共5天。4月27日（周日）上班。
    "2025-04-27": { name: "调休", type: "workday" },  // 周日上班
    "2025-05-01": { name: "劳动节", type: "holiday" },
    "2025-05-02": { name: "劳动节", type: "holiday" },
    "2025-05-03": { name: "劳动节", type: "holiday" },
    "2025-05-04": { name: "劳动节", type: "holiday" },
    "2025-05-05": { name: "劳动节", type: "holiday" },
    
    // 五、端午节：5月31日（周六）至6月2日（周一）放假，共3天。
    "2025-05-31": { name: "端午节", type: "holiday" }, // 周六放假
    "2025-06-01": { name: "端午节", type: "holiday" }, // 周日放假
    "2025-06-02": { name: "端午节", type: "holiday" }, // 周一放假
    
    // 六、国庆节、中秋节：10月1日（周三）至8日（周三）放假调休，共8天。
    // 9月28日（周日）、10月11日（周六）上班。
    "2025-09-28": { name: "调休", type: "workday" },  // 周日上班
    "2025-10-01": { name: "国庆节", type: "holiday" },
    "2025-10-02": { name: "国庆节", type: "holiday" },
    "2025-10-03": { name: "国庆节", type: "holiday" },
    "2025-10-04": { name: "中秋节", type: "holiday" }, // 中秋节
    "2025-10-05": { name: "国庆节/中秋节", type: "holiday" },
    "2025-10-06": { name: "国庆节/中秋节", type: "holiday" },
    "2025-10-07": { name: "国庆节/中秋节", type: "holiday" },
    "2025-10-08": { name: "国庆节/中秋节", type: "holiday" },
    "2025-10-11": { name: "调休", type: "workday" }   // 周六上班
  };

  // 本地存储键名
  const STORAGE_KEY = 'residence_calculator_data';
  const SCHEMES_KEY = 'residence_schemes';

  // 状态管理
  const [travelDates, setTravelDates] = useState(new Set());
  const [initialLocation, setInitialLocation] = useState("hongkong");
  const [stats, setStats] = useState({
    mainland: 0,
    hongkong: 0,
    holidaysInMainland: 0
  });
  const [schemes, setSchemes] = useState([]);
  const [currentScheme, setCurrentScheme] = useState(null);
  const [saveDialogOpen, setSaveDialogOpen] = useState(false);
  const [schemeName, setSchemeName] = useState('');
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [schemeToDelete, setSchemeToDelete] = useState(null);

  // 从本地存储加载数据
  useEffect(() => {
    try {
      const savedData = localStorage.getItem(STORAGE_KEY);
      const savedSchemes = localStorage.getItem(SCHEMES_KEY);
      
      if (savedData) {
        const { travelDates: savedDates, initialLocation: savedLocation } = JSON.parse(savedData);
        setTravelDates(new Set(savedDates));
        setInitialLocation(savedLocation);
      }
      
      if (savedSchemes) {
        setSchemes(JSON.parse(savedSchemes));
      }
    } catch (error) {
      console.error("加载本地数据失败", error);
    }
  }, []);

  // 自动保存当前配置
  useEffect(() => {
    try {
      const saveData = {
        travelDates: Array.from(travelDates),
        initialLocation
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
    } catch (error) {
      console.error("保存数据失败", error);
    }
  }, [travelDates, initialLocation]);

  // 保存为新的方案
  const handleSaveScheme = () => {
    if (!schemeName.trim()) return;
    
    const newScheme = {
      id: Date.now().toString(),
      name: schemeName,
      travelDates: Array.from(travelDates),
      initialLocation,
      createTime: new Date().toISOString(),
      stats: { ...stats }
    };

    const updatedSchemes = [...schemes, newScheme];
    setSchemes(updatedSchemes);
    localStorage.setItem(SCHEMES_KEY, JSON.stringify(updatedSchemes));
    setCurrentScheme(newScheme.id);
    setSaveDialogOpen(false);
    setSchemeName('');
  };

  // 加载已有方案
  const loadScheme = (schemeId) => {
    const target = schemes.find(s => s.id === schemeId);
    if (target) {
      setTravelDates(new Set(target.travelDates));
      setInitialLocation(target.initialLocation);
      setCurrentScheme(target.id);
    }
  };

  // 删除方案确认
  const confirmDeleteScheme = (schemeId, e) => {
    if (e) e.stopPropagation();
    setSchemeToDelete(schemeId);
    setDeleteConfirmOpen(true);
  };

  // 执行删除方案
  const executeDeleteScheme = () => {
    if (!schemeToDelete) return;
    
    const updated = schemes.filter(s => s.id !== schemeToDelete);
    setSchemes(updated);
    localStorage.setItem(SCHEMES_KEY, JSON.stringify(updated));
    
    if (currentScheme === schemeToDelete) {
      setCurrentScheme(null);
    }
    
    setDeleteConfirmOpen(false);
    setSchemeToDelete(null);
  };

  // 生成日期数据
  const generateDaysForMonth = (year, month, totalDays) => {
    const days = [];
    for (let i = 1; i <= totalDays; i++) {
      const date = new Date(year, month - 1, i);
      const dateStr = date.toISOString().split('T')[0];
      const holiday = holidays[dateStr];
      days.push({
        date: dateStr,
        day: i,
        holiday,
        isTravel: travelDates.has(dateStr)
      });
    }
    return days;
  };

  // 计算位置
  const getLocationForDate = (dateStr) => {
    const date = new Date(dateStr);
    const startOfYear = new Date(2025, 0, 1);
    let currentLocation = initialLocation;
    let travelCount = 0;

    // 将旅行日期排序
    const sortedTravelDates = Array.from(travelDates).sort();
    
    // 如果当前日期是出入境日期，直接返回香港
    if (travelDates.has(dateStr)) {
      return "hongkong";
    }

    // 计算在此日期之前的出入境次数
    for (const travelDate of sortedTravelDates) {
      if (new Date(travelDate) < date) {
        travelCount++;
      } else {
        break;
      }
    }

    // 根据旅行次数判断当前位置
    return travelCount % 2 === 0 ? initialLocation : (initialLocation === "mainland" ? "hongkong" : "mainland");
  };

  // 处理日期点击
  const handleDateClick = (dateStr) => {
    const newTravelDates = new Set(travelDates);
    if (newTravelDates.has(dateStr)) {
      newTravelDates.delete(dateStr);
    } else {
      newTravelDates.add(dateStr);
    }
    setTravelDates(newTravelDates);
    // 当修改日期时，重置当前方案选择
    if (currentScheme) {
      setCurrentScheme(null);
    }
  };

  // 更新统计数据
  useEffect(() => {
    let mainland = 0;
    let hongkong = 0;
    let holidaysInMainland = 0;

    const startDate = new Date(2025, 0, 1);
    const endDate = new Date(2025, 11, 31);

    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toISOString().split('T')[0];
      const location = getLocationForDate(dateStr);
      const holiday = holidays[dateStr];

      if (location === "mainland") {
        mainland++;
        if (holiday && holiday.type === "holiday") {
          holidaysInMainland++;
        }
      } else {
        hongkong++;
      }
    }

    setStats({ mainland, hongkong, holidaysInMainland });
  }, [travelDates, initialLocation]);

  // 获取日期样式
  const getDayStyle = (day) => {
    const location = getLocationForDate(day.date);
    const baseStyle = "w-10 h-10 rounded-full flex flex-col items-center justify-center cursor-pointer relative";
    
    if (day.isTravel) {
      return `${baseStyle} bg-purple-200 hover:bg-purple-300 border-2 border-purple-500`;
    }
    
    if (location === "mainland") {
      if (day.holiday) {
        if (day.holiday.type === "holiday") {
          return `${baseStyle} bg-red-200 border-2 border-green-500`;
        } else {
          return `${baseStyle} bg-red-100 border-2 border-yellow-500`; // 调休工作日
        }
      }
      return `${baseStyle} bg-red-100 hover:bg-red-200`;
    }
    
    return `${baseStyle} ${day.holiday?.type === "holiday" ? 'bg-blue-200 border-2 border-green-500' : 'bg-blue-100'} hover:bg-blue-200`;
  };

  // 格式化日期为本地字符串
  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  return (
    <Card className="w-full max-w-6xl mx-auto">
      <CardHeader>
        <div className="flex justify-between items-center">
          <div>
            <CardTitle className="text-xl font-bold">内地与香港居住计算器 (2025年)</CardTitle>
            <CardDescription>直接在日历上点击选择出入境日期，系统会自动计算居住天数。出入境当天计入香港居住时间。</CardDescription>
          </div>
          <div className="flex items-center gap-2">
            <Select value={currentScheme || ''} onValueChange={loadScheme}>
              <SelectTrigger className="w-40">
                <SelectValue placeholder="选择方案" />
              </SelectTrigger>
              <SelectContent>
                {schemes.map(scheme => (
                  <SelectItem key={scheme.id} value={scheme.id}>
                    <div className="flex justify-between items-center w-full">
                      <span>{scheme.name}</span>
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            
            <Button 
              variant="outline" 
              onClick={() => setSaveDialogOpen(true)}
              className="flex items-center gap-2"
            >
              <Save className="w-4 h-4" />
              保存方案
            </Button>
          </div>
        </div>
      </CardHeader>

      <CardContent>
        <div className="space-y-6">
          {/* 初始位置设置 */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">初始位置设置</CardTitle>
              <CardDescription>设置2025年1月1日您所在的位置</CardDescription>
            </CardHeader>
            <CardContent>
              <RadioGroup value={initialLocation} onValueChange={(val) => {
                setInitialLocation(val);
                if (currentScheme) setCurrentScheme(null);
              }}>
                <div className="flex gap-4">
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value="hongkong" id="hongkong" />
                    <Label htmlFor="hongkong" className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-blue-500" />
                      香港
                    </Label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value="mainland" id="mainland" />
                    <Label htmlFor="mainland" className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-red-500" />
                      内地
                    </Label>
                  </div>
                </div>
              </RadioGroup>
            </CardContent>
          </Card>

          {/* 图例说明 */}
          <div className="flex flex-wrap gap-4 p-4 bg-gray-50 rounded-lg">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-red-200" />
              <span>内地</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-blue-200" />
              <span>香港</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-purple-500" />
              <span>出入境日期</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 border-2 border-green-500 rounded-full" />
              <span>法定节假日</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 border-2 border-yellow-500 rounded-full" />
              <span>调休工作日</span>
            </div>
          </div>

          {/* 日历视图 */}
          <div className="grid grid-cols-3 gap-6">
            {months.map(month => (
              <Card key={month.id}>
                <CardHeader className="pb-2">
                  <CardTitle className="text-lg">{month.name}</CardTitle>
                </CardHeader>
                <CardContent>
                  {/* 星期表头 */}
                  <div className="grid grid-cols-7 gap-1 mb-2">
                    {["日", "一", "二", "三", "四", "五", "六"].map(day => (
                      <div key={day} className="text-center text-xs text-gray-500">
                        {day}
                      </div>
                    ))}
                  </div>

                  {/* 日期格子 */}
                  <div className="grid grid-cols-7 gap-1">
                    {/* 填充月初空白 */}
                    {Array.from({ length: new Date(month.year, month.month - 1, 1).getDay() }).map((_, i) => (
                      <div key={`empty-start-${i}`} className="w-10 h-10" />
                    ))}

                    {/* 日期 */}
                    {generateDaysForMonth(month.year, month.month, month.days).map(day => (
                      <TooltipProvider key={day.date}>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <div
                              className={getDayStyle(day)}
                              onClick={() => handleDateClick(day.date)}
                            >
                              <span className="text-sm">{day.day}</span>
                              {day.holiday && (
                                <span className="text-[10px] text-green-700">
                                  {day.holiday.type === "holiday" ? 
                                    (day.holiday.name.length > 4 ? 
                                      (day.holiday.name === "国庆节/中秋节" ? "双节" : day.holiday.name.substring(0, 3)) 
                                      : day.holiday.name) 
                                    : "调休"}
                                </span>
                              )}
                            </div>
                          </TooltipTrigger>
                          <TooltipContent>
                            <p>
                              {day.date}
                              {day.holiday ? ` (${day.holiday.name})` : ''}
                              {day.isTravel ? ' - 出入境日期' : ''}
                            </p>
                          </TooltipContent>
                        </Tooltip>
                      </TooltipProvider>
                    ))}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          {/* 统计结果 */}
          <div className="grid grid-cols-3 gap-4">
            <Card>
              <CardContent className="pt-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="font-medium">内地居住</h3>
                    <p className="text-sm text-gray-500">含节假日 {stats.holidaysInMainland} 天</p>
                  </div>
                  <div className="text-2xl font-bold text-red-500">{stats.mainland}天</div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="pt-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="font-medium">香港居住</h3>
                    <p className="text-sm text-gray-500">含出入境当天</p>
                  </div>
                  <div className="text-2xl font-bold text-blue-500">{stats.hongkong}天</div>
                </div>
              </CardContent>
            </Card>

            <Card className="bg-gray-50">
              <CardContent className="pt-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="font-medium">总计天数</h3>
                    <p className="text-sm text-gray-500">2025年全年</p>
                  </div>
                  <div className="text-2xl font-bold">365天</div>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* 已保存方案列表 */}
          {schemes.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">已保存方案</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  {schemes.map(scheme => (
                    <div 
                      key={scheme.id} 
                      className={`flex justify-between items-center p-3 rounded-md cursor-pointer hover:bg-gray-100 ${currentScheme === scheme.id ? 'bg-blue-50 border border-blue-200' : ''}`}
                      onClick={() => loadScheme(scheme.id)}
                    >
                      <div>
                        <div className="font-medium">{scheme.name}</div>
                        <div className="text-xs text-gray-500">创建于: {formatDate(scheme.createTime)}</div>
                      </div>
                      <div className="flex items-center gap-4">
                        <div className="text-sm">
                          <span className="text-red-500">内地: {scheme.stats?.mainland || '?'}天</span> | 
                          <span className="text-blue-500"> 香港: {scheme.stats?.hongkong || '?'}天</span>
                        </div>
                        <Button 
                          variant="ghost" 
                          size="icon"
                          onClick={(e) => confirmDeleteScheme(scheme.id, e)}
                        >
                          <Trash2 className="h-4 w-4 text-gray-500" />
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}

          {/* 底部操作按钮 */}
          <div className="flex justify-between">
            <div className="text-sm text-gray-500">
              数据已自动保存在本地浏览器，清除浏览器数据将丢失
            </div>
            <Button 
              variant="outline" 
              className="flex items-center gap-2"
              onClick={() => {
                setTravelDates(new Set());
                setInitialLocation("hongkong");
                setCurrentScheme(null);
              }}
            >
              <RefreshCw className="w-4 h-4" />
              重置所有选择
            </Button>
          </div>
        </div>
      </CardContent>

      {/* 保存方案对话框 */}
      <Dialog open={saveDialogOpen} onOpenChange={setSaveDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>保存当前方案</DialogTitle>
          </DialogHeader>
          <div className="py-4">
            <Label htmlFor="scheme-name" className="block mb-2">方案名称</Label>
            <Input 
              id="scheme-name"
              placeholder="例如：春节假期计划" 
              value={schemeName}
              onChange={(e) => setSchemeName(e.target.value)}
            />
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setSaveDialogOpen(false)}>
              取消
            </Button>
            <Button onClick={handleSaveScheme} disabled={!schemeName.trim()}>
              保存
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* 删除确认对话框 */}
      <Dialog open={deleteConfirmOpen} onOpenChange={setDeleteConfirmOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>确认删除</DialogTitle>
          </DialogHeader>
          <div className="py-4">
            确定要删除这个方案吗？此操作无法撤销。
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDeleteConfirmOpen(false)}>
              取消
            </Button>
            <Button variant="destructive" onClick={executeDeleteScheme}>
              删除
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </Card>
  );
};

export default ResidenceCalculator;
